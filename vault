#!/bin/bash

# usage: sudo sh vault open <vault_file> <mountpoint>
# usage: sudo sh vault close <vault_file>
# usage: sudo sh vault create <vault_file> <size>

set -e

# options (open, close, create)
option=$1
# vault file name
vault_file=$2
# create traceable /dev/mapper name
mapping_name="v_$(date +%H%M%S)"


create() {

	printf "writing random data to $vault_file\n"
	dd \
		if=/dev/random \
		of=$vault_file \
		bs=1M \
		count=$size \
		iflag=fullblock \
		status=progress
	printf "setting up crypto on $vault_file\n"
	## luks2
	cryptsetup -y luksFormat $vault_file
	## plain dm-crypt
	#cryptsetup \
	#	-y \
	#	--type plain \
	#	--cipher=aes-xts-plain64 \
	#	--hash=sha512 \
	#	--key-size=512 \
	#	--offset=0 \
	##	--key-file=/dev/sdX \
	#	--keyfile-offset=0 \
	#	$vault_file enc
	printf "validating $vault_file:\n"
	file $vault_file

}


open_luks() {

	printf "opening luks $vault_file to $mapping_name\n"
	sudo cryptsetup open $vault_file $mapping_name

}


make_fs () {

	printf "writing ext4 filesystem to /dev/mapper/$mapping_name\n"
	sudo mkfs.ext4 -L VAULT -j /dev/mapper/$mapping_name

}


mounting() {

	printf "mounting /dev/mapper/$mapping_name to $mountpoint\n"
	sudo mount /dev/mapper/$mapping_name $mountpoint

}


permissions() {

	printf "write permission to $mountpoint\n"
	sudo chown -R cytopyge:wheel $mountpoint

}


umounting() {

	mountpoint=$(mount -l | grep 'v_[0-9][0-9][0-9][0-9][0-9][0-9]' | awk '{print $3}')
	printf "unmounting $mountpoint\n"
	sudo umount $mountpoint

}


close_luks() {

	mapping_name=$(lsblk -lp | grep 'v_[0-9][0-9][0-9][0-9][0-9][0-9]' | awk '{print $1}')
	printf "closing luks $mapping_name\n"
	sudo cryptsetup close $mapping_name

}


clear_cache() {

	printf "clearing cache\n"
	sudo sysctl --write vm/drop_caches=3

}


if [[ $option == "create" ]]; then

	size=$3
	[[ $size -lt 18 ]] && \
	# to prevent error: 'Requested offset is beyond real size of device'
	printf "minimum vault size is 18 MB\n" && exit 18

	create
	open_luks
	make_fs
	close_luks

fi


if [[ $option == "open" ]]; then

	mountpoint=$3

	open_luks
	mounting
	permissions

fi


if [[ $option == "close" ]]; then

	umounting
	close_luks
	clear_cache

fi
