#!/bin/bash

# usage: sudo sh vault open <vault_file> <mountpoint>
# usage: sudo sh vault close <vault_file>
# usage: sudo sh vault create <vault_file> <size>

set -e

# options (open, close, create)
option=$1
# vault file name
vault_file=$2
# create traceable /dev/mapper name
random_hex="$(< /dev/random tr -d -c "[:xdigit:]" | head -c 6)"
mapping_name="vlt_$random_hex"


source $HOME/_git/code/sources/functions/reply_functions

check_file_exists() {

	if [[ -f $vault_file ]]; then

		printf "$vault_file already exists!\n"
		printf "overwrite? (y/N) "
		reply_single
		echo

		if printf "$reply" | grep -iq "^y"; then

			printf "about to overwrite $vault_file\n"
			printf "sure? (y/N) "
			reply_single
			echo

			if printf "$reply" | grep -iq "^y"; then

				return

			else

				printf "abort overwriting $vault_file\n"
				exit 11

			fi

		else

			printf "abort overwriting $vault_file\n"
			exit 2

		fi

	fi

}


check_mp_dir() {

	## existence & emptyness
	if [[ -d $mountpoint ]]; then
		if [ "$(ls -A $mountpoint)" ]; then
			printf "$mountpoint is not empty!\n" && exit 3
		fi
	else
		printf "$mountpoint does not exist!\n" && exit 3
	fi

}



create() {

	echo
	printf "writing random data to $vault_file\n"
	dd \
		if=/dev/random \
		of=$vault_file \
		bs=1M \
		count=$size \
		iflag=fullblock \
		status=progress

	echo
	printf "setting up crypto on $vault_file\n"

	## luks2
	cryptsetup -y luksFormat $vault_file
	## plain dm-crypt
	#cryptsetup \
	#	-y \
	#	--type plain \
	#	--cipher=aes-xts-plain64 \
	#	--hash=sha512 \
	#	--key-size=512 \
	#	--offset=0 \
	##	--key-file=/dev/sdX \
	#	--keyfile-offset=0 \
	#	$vault_file enc
	echo
	printf "validating $vault_file:\n"
	file $vault_file

}


open_luks() {

	echo
	printf "opening $vault_file to $mapping_name\n"
	sudo cryptsetup open $vault_file $mapping_name

}


make_fs () {

	echo
	printf "writing ext4 filesystem to /dev/mapper/$mapping_name\n"
	sudo mkfs.ext4 -L VAULT -j /dev/mapper/$mapping_name

}


mounting() {

	printf "mounting /dev/mapper/$mapping_name to $mountpoint\n"
	sudo mount /dev/mapper/$mapping_name $mountpoint

}


permissions() {

	printf "write permission to $mountpoint\n"
	sudo chown -R $USER:wheel $mountpoint

}


umounting() {

	mp_and_map=$(lsblk -p $(losetup -j $vault_file | awk -F : '{print $1}') | tail -n 1)
	mountpoint=$(echo "$mp_and_map" | awk '{print $7}')
	printf "unmounting $mountpoint\n"
	sudo umount $mountpoint

}


close_luks() {

	mp_and_map=$(lsblk -p $(losetup -j $vault_file | awk -F : '{print $1}') | tail -n 1)
	mapping_name=$(echo "$mp_and_map" | awk '{print $1}' | cut -c 3-)
	printf "closing luks $mapping_name\n"
	sudo cryptsetup close $mapping_name

}


clear_cache() {

	printf "clearing cache\n"
	sudo sysctl --write vm/drop_caches=3

}


if [[ $option == "create" ]]; then

	size=$3
	[[ $size -lt 18 ]] && \
	# to prevent error: 'Requested offset is beyond real size of device'
	printf "minimum vault size is 18 MB\n" && exit 18
	# temporary mountpoint
	mountpoint="$HOME/_temp/$random_hex"
	mkdir -p "$mountpoint"

	check_file_exists
	create
	open_luks
	make_fs
	permissions
	close_luks

	rmdir "$mountpoint"

fi


if [[ $option == "open" ]]; then

	mountpoint=$3

	check_mp_dir
	open_luks
	permissions
	mounting

fi


if [[ $option == "close" ]]; then

	umounting
	close_luks
	clear_cache

fi
