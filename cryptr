#!/bin/bash
#
##
### usage: enc_bu -e <source> <destination>
### usage: enc_bu -d <source> <destination>
###
###
#

args="$@"
opr=$1
src=$(realpath "$2")
dst=$(realpath "$3")

timestamp="`date "+%Y%m%d_%H%M%S"`"

cipher_list=$(\
	openssl enc -ciphers | \
	awk 'NR > 1 {for(i=1;i<=NF;i++){print $i}}' \
	)

tmp_dir="$XDG_CACHE_HOME/temp/cryptr/$timestamp"
[[ ! -d $tmp_dir ]] && mkdir -p $tmp_dir

pwd_dir="$PWD"


oper()
{
	# operation: encrypt or decrypt
	if [[ $opr == "-e" ]]; then

		oper="encr"

	elif [[ $opr == "-d" ]]; then

		oper="decr"

	fi
}


source_type()
{
	# source is file or directory
	# (only for oper = encr)
	if [[ -f $src ]]; then

		source_type='file'

	elif [[ -d $src ]]; then

		source_type='dir'

	fi
}


create_tar()
{
	tar_file=$tmp_dir/$src.tar
	sub_dir=$(dirname $src)

	# create tar archive
	tar -cvf $tar_file -C $sub_dir $src
}


select_ciphers()
{
	#cipher pool array
	cipher_pool=($(\
		openssl enc -ciphers | \
		awk 'NR > 1 {for(i=1;i<=NF;i++){print $i}}' | \
		cut -c 2- | \
		fzf -m \
		))
	cipher_pool_amount=${#cipher_pool[@]}
}


create_cipher_pool_file()
{
	cipher_pool_file="$(dirname $dst)/$(basename $src).cpf"
	printf "%s\n" ${cipher_pool[@]} > "$cipher_pool_file"
}


running_rounds()
{
	round=1
	rounds=$cipher_pool_amount

	for cipher in ${cipher_pool[@]}; do

		printf "$round/$rounds $cipher\n"

		case $round in

			1)
				case $rounds in

					1)
						encrypt_once
						;;

					*)
						encrypt_first
						;;

				esac
				;;

			$rounds )
				encrypt_last
				;;

			*)
				encrypt_next
				;;

		esac

		round=$(( $round + 1 ))

	done
}


encrypt_first()
{
	# first encryption round

	## define file_in
	if [[ $source_type == "file" ]]; then

		file_in="$src"

	elif [[ $source_type == "dir" ]]; then

		file_in="$tar_file"

	fi

	## define file_out
	file_out=$tmp_dir/$(basename $file_in).$round

	## encrypt
	openssl enc -$opr -base64 -$cipher -salt -pbkdf2 -in $file_in -out $file_out -pass pass:$pd
}


encrypt_next()
{
	# next encryption round

	## define file_in
	file_in="$file_out"

	## define file_out
	file_out=$tmp_dir/$(basename $file_in).$round

	# next ecryption round
	openssl enc -$opr -base64 -$cipher -salt -pbkdf2 -in $file_in -out $file_out -pass pass:$pd
}


encrypt_last()
{
	## define file_out
	file_out=$dst

	# last encryption round
	openssl enc -$opr -base64 -$cipher -salt -pbkdf2 -in $file_in -out $file_out -pass pass:$pd
}


encrypt_once()
{
	## define file_in
	if [[ $source_type == "file" ]]; then

		file_in="$src"

	elif [[ $source_type == "dir" ]]; then

		file_in="$tar_file"

	fi

	## define file_out
	file_out=$dst

	openssl enc -$opr -base64 -$cipher -salt -pbkdf2 -in $file_in -out $file_out -pass pass:$pd
}


encrypt()
{
	select_ciphers
	create_cipher_pool_file
	running_rounds
	create_box
	cleanup
}


decrypt_once()
{
	file_in="timestamp"
	file_out=$dst
}


decrypt()
{
	[[ -z $dst ]] && dst=$pwd_dir

	check_if_box
	#open_box

	running_rounds
}


openssl_e_d()
{
	openssl enc -$opr -base64 -aes-256-cbc -salt -pbkdf2 -in $file_in -out $file_out -pass pass:$pd

}


extract_tar()
{
	# extract tar archive
	tar -xvf $tmp_dir
}


destroy_tar()
{
	rm -rf $tmp_dir
}


get_password()
{
	#[TODO] DEV
	pd="1"
}


create_box()
{
	tar_file=$(dirname $dst)/$(basename $src).box

	files="$dst $cipher_pool_file"

	# create tar archive
	tar -cvf $tar_file -C $(dirname $tar_file) $files
}


check_if_box()
{
	if [[ -n $(printf "$src" | grep '.box$') ]]; then

		if [[ -n $($(file -b $src) | grep 'tar archive') ]]; then

			# src is a tar file with box extension
			open_box

		fi

	fi
}


open_box()
{
	# extract box contents (2 files)
	mkdir -p $tmp_dir
	tar -xvf $src -C $tmp_dir

	# find .cryptfile
	crypt_file=$(find $tmp_dir -name "*.crypt")

	# find cypher pool file
	cipher_pool_file=$(find $tmp_dir -name "*.cpf")
}


get_box_contents()
{
	cipher_pool=($(tac $cipher_pool_file))
	cipher_pool_amount=${#cipher_pool[@]}
}


cleanup()
{
	case $oper in

		encr)
			destroy_tar
			rm -rf $files
			;;

		decr)
			#[TODO] destroy_opened_box
			;;

	esac
}


main()
{
	oper
	get_password

	case $oper in

		encr)

			source_type

			case $source_type in

				file)

					encrypt
					;;

				dir)
					create_tar
					encrypt
					;;

			esac
			;;

		decr)

			decrypt
			extract_tar
			;;

	esac
}

main
